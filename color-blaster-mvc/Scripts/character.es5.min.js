"use strict";var Game={canvasId:"gameCanvas",canvasBackgroundColor:"#6bd0ff",canvasGridColor:"#ffffff",gameType:"arcade",levelStarted:!1,levelText:undefined,scoreText:undefined,timestamp:Date.now(),totalSecondsPassed:0,secondsTowardInterval:0,animationInterval:.02,tileWidth:35,tileHeight:35,spaceAtEdges:3,bulletRadius:3,canvas:undefined,context:undefined,level:undefined,levels:allLevels,levelNumber:1,character:undefined,allowExit:!0,npcs:undefined,npcsMoving:!1,showOpeningScene:!0,newOrLoadChosen:!1,openingScene:null,currentAnimationInterval:null,inScene:!1,currentConversation:null,currentDialogue:null,allowDialogue:!1,blobs:undefined,levelHelpedBlobs:undefined,helpedBlobs:undefined,inventory:undefined,showInventoryMenu:!1,showItem:!1,itemToShow:null,bullets:undefined,bulletSpeed:9,absorbRay:undefined,rayDisplay:undefined,emptyAbsorbHex:"grey",rayWidth:6,raySecondsPassed:0,raySecondsInterval:.2,confusedImage:undefined,blocks:undefined,levelClearedBlocks:undefined,clearedBlocks:undefined,door:undefined,doorColor:"#004666",levelScore:0,score:0,whiteValue:1,primaryValue:3,secondaryValue:6,blackValue:12,keyPresses:undefined,disallowMovement:!1,progressDisplayed:!1,load:function(){var n,t,i,r;for(levelTileWidth=this.tileWidth,levelTileHeight=this.tileHeight,console.log("loading"),generateAllLevels(this.gameType),this.character=MainCharacter,this.npcs=[],this.blobs=[],this.levelHelpedBlobs=[],this.helpedBlobs=[],this.levels=allLevels,this.level=this.levels[0],this.scoreText=document.getElementById("scoreText"),this.levelText=document.getElementById("levelText"),this.inventory=Inventory,this.bullets=[],this.absorbRay=null,this.rayDisplay=null,this.confusedImage=new Image,this.confusedImage.src="images/confused.png",this.blocks=[],this.levelClearedBlocks=[],this.clearedBlocks=[],this.keyPresses={},this.inventory.load(this.level),this.showInventory(),n=this.level.rows,n<14&&(n=14),t=0;t<this.level.columns;t++){for(i=[],r=0;r<n;r++)i.push(null);this.blocks.push(i)}this.run()},run:function(){console.log("running");this.canvas=$("#"+this.canvasId);this.context=this.canvas[0].getContext("2d");this.setCanvas();this.setGameArea();this.loadLevel();window.requestAnimationFrame(this.gameLoop);window.addEventListener("keydown",this.keyDownListener,!1);window.addEventListener("keyup",this.keyUpListener,!1);showGameTypeModal(this)},setGameType:function(n){this.gameType=n;this.load();gameTypeModal.style.display="none";this.gameModeChosen=!0;showNewOrSaveModal(this)},goToNextLevel:function(n){this.levelNumber!=this.levels.length&&(this.showOpeningScene=n===!1?!1:!0,this.level=this.levels[this.levelNumber],this.levelNumber++,this.levelScore=0,this.loadLevel())},displayProgress:function(n){function t(){return n.apply(this,arguments)}return t.toString=function(){return n.toString()},t}(function(){displayProgress(this)}),loadLevel:function(){var u,e,t,r,n,i,o,f,c,s,h;for(this.inventory.absorbColorElements[0].className="absorb-color selected",this.inventory.absorbColorElements[1].className="absorb-color",this.inventory.absorbColorElements[2].className="absorb-color",this.npcs=[],this.blobs=[],this.blocks=[],this.levelHelpedBlobs=[],this.levelClearedBlocks=[],this.inventory.load(this.level),this.showInventory(),u=this.level.rows,u<14&&(u=14),i=0;i<this.level.columns;i++){for(e=[],n=0;n<u;n++)e.push(null);this.blocks.push(e)}if(this.setCanvas(),this.setGameArea(),this.character.resetPosition(this.level.columns),this.drawCharacter(),this.level.isSpecialLevel)for(t=this.level.map,r=0,n=0;n<t.grid.length;n++)for(i=0;i<t.grid[n].length;i++)t.items[t.grid[n][i]]!=null&&t.items[t.grid[n][i]].includes("block")?(o=t.items[t.grid[n][i]],f=o.length,f=f-6,c=o.substring(0,f),s=new Block(this.tileWidth,this.tileHeight,i,n,c),this.blocks[i][n]=s,this.drawBlock(s)):t.items[t.grid[n][i]]!=null&&t.items[t.grid[n][i]].includes("blob")&&(h=new Blob(i,n,this.level.blobSpeeds[r],this.level.blobColors[r],this.level.blobDesiredColors[r],this.tileWidth,this.tileHeight),this.blobs.push(h),this.drawBlob(h),r++),t.items[t.grid[n][i]]!=null&&t.items[t.grid[n][i]].includes("npc")&&(t.items[t.grid[n][i]].includes("sarah")?(Sarah.startXi=i,Sarah.startYi=n,Sarah.resetPosition(this.level.columns),this.npcs.push(Sarah)):t.items[t.grid[n][i]].includes("george")?(George.startXi=i,George.startYi=n,George.resetPosition(this.level.columns),this.npcs.push(George)):t.items[t.grid[n][i]].includes("onorio")&&(Onorio.startXi=i,Onorio.startYi=n,Onorio.resetPosition(this.level.columns),this.npcs.push(Onorio)));else this.fillWithBlocks(),this.generateBlobs();this.createDoor();this.drawDoor();this.levelText.innerHTML=this.levelNumber;this.level.isSpecialLevel?this.setOpeningScene():(this.openingScene=null,this.currentConversation=null,this.currentDialogue=null,this.currentAnimationInterval=null,this.inScene=!1)},keyDownListener:function(n){if(Game.levelStarted!==!1||Game.inScene!==!0||(n.key=="Enter"||n.key==" ")&&Game.allowDialogue!==!1)if(this.keyPresses===undefined&&(this.keyPresses={}),this.keyPresses[n.key]=!0,console.log('Key pressed: "'+n.key+'"'),n.key==="Enter")Game.currentDialogue!=null&&Game.allowDialogue?(Game.getNextDialogue(),Game.showOpeningScene||Game.currentDialogue!==null||(Game.openingScene.repeatConvoSeen=!0,Game.currentConversation=null)):Game.showInventoryMenu?Game.inventory.menu.useItem(Game):instructionsModal.style.display!="none"?(instructionsModal.style.display="none",Game.levelStarted=!0):deathModal.style.display!="none"?(deathModal.style.display="none",Game.levelStarted=!0):progressModal.style.display!="none"?(progressModal.style.display="none",Game.levelStarted=!0):saveModal.style.display!="none"&&(saveModal.style.display="none",Game.levelStarted=!0,saveModal.focus());else if(n.key==="i"||n.key==="I")Game.showInventoryMenu||Game.inScene?Game.showInventoryMenu&&!Game.inScene&&(Game.disallowMovement=!1,Game.showInventoryMenu=!1,Game.levelStarted=!0):(Game.disallowMovement=!0,Game.showInventoryMenu=!0,Game.levelStarted=!1);else if(n.key==="ArrowUp"||n.key==="ArrowDown"||n.key==="ArrowLeft"||n.key==="ArrowRight")if(Game.showInventoryMenu)n.key==="ArrowUp"?Game.inventory.menu.selectItem("up"):n.key==="ArrowDown"?Game.inventory.menu.selectItem("down"):n.key==="ArrowLeft"?Game.inventory.menu.selectItem("left"):n.key==="ArrowRight"&&Game.inventory.menu.selectItem("right");else{if(Game.disallowMovement)return;Game.changeSpriteState(n.key,"start")}else n.key===" "||n.key==="Spacebar"?Game.showInventoryMenu?Game.inventory.menu.useItem(Game):Game.currentDialogue!=null&&Game.allowDialogue?(Game.getNextDialogue(),Game.showOpeningScene||Game.currentDialogue!==null||(Game.openingScene.repeatConvoSeen=!0,Game.currentConversation=null)):(Game.setShootOrAbsorb(),Game.inventory.shootOrAbsorb==="shoot"?Game.shootBullet(Game.character,"normal"):Game.shootAbsorbRay()):n.key==="a"||n.key==="A"?Game.showInventoryMenu?Game.inventory.menu.selectCategory("previous"):(Game.inventory.selectVial("up"),playSound("select vial"),Game.showInventory()):n.key==="z"||n.key==="Z"?Game.showInventoryMenu?Game.inventory.menu.selectCategory("next"):(Game.inventory.selectVial("down"),playSound("select vial"),Game.showInventory()):n.key==="q"||n.key==="Q"?Game.inventory.selectAbsorbColor("up",Game.levelStarted):(n.key==="w"||n.key==="W")&&Game.inventory.selectAbsorbColor("down",Game.levelStarted)},keyUpListener:function(n){Game.keyPresses[n.key]=!1;(n.key==="ArrowUp"||n.key==="ArrowDown"||n.key==="ArrowLeft"||n.key==="ArrowRight")&&Game.changeSpriteState(n.key,"stop")},gameLoop:function(){var i=Date.now(),t=(i-Game.timestamp)/1e3,n;if(Game.timestamp=i,Game.secondsTowardInterval+=t,Game.totalSecondsPassed+=t,Game.absorbRay!=null&&Game.rayDisplay!=null?Game.raySecondsPassed+=t:Game.raySecondsPassed=0,Game.secondsTowardInterval>Game.animationInterval){if(Game.secondsTowardInterval=0,Game.drawGrid(),Game.redrawBlocks(),Game.continueSpriteFrames(Game.character),Game.moveCharacter(Game.character,Game.character.goalX,Game.character.goalY),Game.npcsMoving)for(n=0;n<Game.npcs.length;n++)Game.continueSpriteFrames(Game.npcs[n]),Game.moveCharacter(Game.npcs[n],Game.npcs[n].goalX,Game.npcs[n].goalY);Game.moveBlobs();Game.drawBlobsAndCharacter();Game.drawBullets();Game.moveBullets();Game.drawRay();Game.drawDoor();Game.checkBlobCharacterCollision();Game.checkDoorCollision();Game.level.isSpecialLevel&&(Game.inScene&&Game.gameModeChosen&Game.newOrLoadChosen?!Game.showOpeningScene&&Game.level.openingScene.startAtEndOnReturn?Game.inScene=!1:Game.showNextInScene():(Game.showDialogue(),Game.currentConversation!=null&&Game.currentConversation.type==="exit"&&(Game.currentDialogue==null||Game.currentDialogue.complete?Game.currentAnimationInterval!=null&&(Game.allowDialogue=!1,Game.performExitAnimation()):Game.allowDialogue=!0),Game.showInventoryMenu&&Game.inventory.menu.drawMenu(Game.context)))}window.requestAnimationFrame(Game.gameLoop)},generateBlobs:function(){this.blobs.length=0;for(var n=0;n<this.level.blobCount;n++)this.generateBlob()},generateBlob:function(){var s=!1,t=null,i,r,a,o;do{var u=getTileColors(this.level),f=undefined,n=undefined,h=!1;do{if(f=Math.floor(Math.random()*this.level.columns),i=this.level.rows,i<14&&(i=14),this.level.blobsMustBeInBlocks){var c=!1,v=this.spaceAtEdges+1,y=i-this.spaceAtEdges-2;do n=Math.floor(Math.random()*this.level.rows),n>=v&&n<=y&&(c=!0);while(!c)}else i--,n=Math.floor(Math.random()*this.level.rows);for(r=0;r<this.blobs.length;r++)if(this.blobs[r].Xi===f&&this.blobs[r].Yi===n){h=!0;break}}while(h);var l=Math.floor(Math.random()*u.length),p=u[l],e=0;do e=Math.floor(Math.random()*u.length);while(e===l);a=u[e];o=this.level.maxBlobSpeed;this.level.randomizeBlobSpeed&&(o=Math.ceil(Math.random()*this.level.maxBlobSpeed));t=new Blob(f,n,o,p,a,this.tileWidth,this.tileHeight);s=this.isBlobCharacterCollision(t)}while(s);this.blocks[t.Xi][t.Yi]=null;this.blobs.push(t)},canMoveBlobInDirection:function(n,t){var o=n.getNewDirectionCoordinates(t),i=o[0],r=o[1],s=this.context.canvas.width-n.spriteWidth+n.rightEmptyPixels,h=this.context.canvas.height-n.spriteHeight,f;if(i<0||i>=s||r<0||r>=h)return!1;var c=this.isBlockCollision("blob",i,r,n),u=this.getRelativePosition(i,r),e=!1;for(f=0;f<this.npcs.length;f++)if(this.isBlobNpcCollision(this.npcs[f],u[0],u[1])){e=!0;console.log("Npc blob collision detected");break}return c||e?!1:(this.character.pipe.state!=0&&(u[0]===this.character.pipe.Xi||u[1]===this.character.pipe.Yi)&&(e=!0),!0)},moveBlobs:function(){if(this.levelStarted!==!1)for(var n=0;n<this.blobs.length;n++)this.moveBlob(this.blobs[n])},moveBlobTowardExit:function(n){var r,u,e;this.allowExit=!1;var t=this.door.x+this.tileWidth-n.spriteWidth/2,i=this.context.canvas.height-1,f=undefined;if(t>=n.positionBeforeExitX?(u=Math.floor((t-n.positionBeforeExitX)/2),f=n.positionBeforeExitX+u):(u=Math.floor((n.positionBeforeExitX-t)/2),f=n.positionBeforeExitX-u),r=undefined,i>=n.positionBeforeExitY?(u=Math.floor((i-n.positionBeforeExitY)/2),r=n.positionBeforeExitY+u):(u=Math.floor((n.positionBeforeExitY-i)/2),r=n.positionBeforeExitY-u),n.x!=f&&n.x!=t&&n.y!=r?t>=n.x?(n.setMoveDirection("right",f,n.y),this.moveBlob(n),n.direction="exit"):f<n.x&&(n.setMoveDirection("left",f,n.y),this.moveBlob(n),n.direction="exit"):n.x===f&&n.y!=r?r>=n.y?(n.setMoveDirection("forward",n.x,r),this.moveBlob(n),n.direction="exit"):i<n.y&&(n.setMoveDirection("forward",n.x,r),this.moveBlob(n),n.direction="exit"):n.x!=t&&n.y===r?t>=n.x?(n.setMoveDirection("right",t,n.y),this.moveBlob(n),n.direction="exit"):t<n.x&&(n.setMoveDirection("left",t,n.y),this.moveBlob(n),n.direction="exit"):i>=n.y?(n.setMoveDirection("forward",n.x,i),this.moveBlob(n),n.direction="exit"):i<n.y&&(n.setMoveDirection("forward",n.x,i),this.moveBlob(n),n.direction="exit"),n.x===t&&n.y===i){for(this.addBlobToScore(n),this.levelHelpedBlobs.push(n),e=0;e<this.blobs.length;e++)if(this.blobs[e]===n){this.blobs.splice(e,1);break}this.allowExit=!0}},moveBlob:function(n){(n.direction==="none"&&n.thoughts.currentThought===n.thoughts.happyThought?n.direction="exit":n.direction==="none"&&n.hasPassedMoveChangeInterval()&&this.setBlobDirection(n),n.direction!=="none")&&(n.direction==="exit"&&(n.speed=2,this.moveBlobTowardExit(n)),n.x+=n.xSpeed,n.y+=n.ySpeed,n.xSpeed!=0&&n.lessThanGoalX?n.x<=n.goalX&&(n.x=n.goalX,n.setMoveDirection("none",n.x,n.y)):n.xSpeed==0||n.lessThanGoalX||n.x>=n.goalX&&(n.x=n.goalX,n.setMoveDirection("none",n.x,n.y)),n.ySpeed!=0&&n.lessThanGoalY?n.y<=n.goalY&&(n.y=n.goalY,n.setMoveDirection("none",n.x,n.y)):n.ySpeed==0||n.lessThanGoalY||n.y>=n.goalY&&(n.y=n.goalY,n.setMoveDirection("none",n.x,n.y)))},setBlobDirection:function(n){var t,i,r,u,f,e;if(n.direction=="none"){for(t=["forward","backward","left","right"],i="none",r=0;r<4;r++)if(u=this.getRandomDirectionIndex(t),f=t[u],this.canMoveBlobInDirection(n,f)){i=f;break}else t.splice(u,1);e=n.getNewDirectionCoordinates(i);n.setMoveDirection(i,e[0],e[1])}},getRandomDirection:function(n){var t=Math.floor(Math.random*n.length);return n[t]},getRandomDirectionIndex:function(n){return Math.floor(Math.random()*n.length)},drawBlob:function(n){var e=n.currentStateFrame.startX,o=n.currentStateFrame.startY,r=n.currentStateFrame.width,u=n.currentStateFrame.height,l=Math.round((n.currentStateFrame.width-this.tileWidth)/2),a=Math.round((n.currentStateFrame.height-this.tileHeight)/2),t=n.x,i=n.y;t<n.xOffset?t=n.xOffset:t+r>this.canvas.width&&(t=this.canvas.width-r);i<n.yOffset?i=n.yOffset:i+u>this.canvas.height&&(i=this.canvas.height-u);n.x=t;n.y=i;var s=r,h=u,f=n.currentStateFrame.image,c=f.complete&&f.naturalHeight!==0;c?(Game.context.drawImage(f,e,o,r,u,t,i,s,h),Game.drawThought(n,t,i)):f.addEventListener("load",function(){Game.context.drawImage(f,e,o,r,u,t,i,s,h);Game.drawThought(n,t,i)})},drawThought:function(n,t,i){var e=n.thoughts.currentThought.startX,o=n.thoughts.currentThought.startY,u=n.thoughts.currentThought.width,f=n.thoughts.currentThought.height,s=t+n.thoughts.offX,h=i+n.thoughts.offY,c=u,l=f,r=n.thoughts.getThoughtImage(),a;r!=null&&(a=r.complete&&r.naturalHeight!==0,a?Game.context.drawImage(r,e,o,u,f,s,h,c,l):r.addEventListener("load",function(){Game.context.drawImage(r,e,o,u,f,s,h,c,l)}))},drawCharacterThought:function(n,t,i){n.thoughts.currentThought!=null&&function(){var a;n.direction==="forward"?(n.thoughts.offX=35,n.thoughts.offY=4):n.direction==="right"?(n.thoughts.offX=33,n.thoughts.offY=4):n.direction==="left"?(n.thoughts.offX=32,n.thoughts.offY=4):n.direction==="backward"&&(n.thoughts.offX=33,n.thoughts.offY=-2);var e=n.thoughts.currentThought.startX,o=n.thoughts.currentThought.startY,u=n.thoughts.currentThought.width,f=n.thoughts.currentThought.height,s=t+n.thoughts.offX,h=i+n.thoughts.offY,c=u,l=f,r=n.thoughts.getThoughtImage();r!=null&&(a=r.complete&&r.naturalHeight!==0,a?Game.context.drawImage(r,e,o,u,f,s,h,c,l):r.addEventListener("load",function(){Game.context.drawImage(r,e,o,u,f,s,h,c,l)}))}()},changeBlobFrame:function(n){if(n.hasPassedTimeInterval()){var t=n.lastFrameIndex+1;t>=n.currentState.frames.length-1&&(t=0);n.currentStateFrame=n.currentState.frames[t];n.lastFrameIndex=t}},drawBlobsAndCharacter:function(){for(var t,i,r,u,f=[],e=[],n=0;n<this.blobs.length;n++)this.blobs[n].y<this.character.y+this.character.spriteHeight/2?f.push(this.blobs[n]):e.push(this.blobs[n]);for(t=[],i=[],n=0;n<this.npcs.length;n++)r=undefined,u=undefined,this.npcs[n].species==="human"?(r=this.npcs[n].y+this.npcs[n].spriteHeight/2+8,u=this.character.y+this.character.spriteHeight/2):(r=this.npcs[n].y,u=this.character.y+this.character.spriteHeight/2),this.npcs[n].y+this.npcs[n].spriteHeight<this.character.y+this.character.spriteHeight?t.push(this.npcs[n]):i.push(this.npcs[n]);this.drawBlobs(f);this.drawNpcs(t);this.drawCharacter();this.drawNpcs(i);this.drawBlobs(e)},drawBlobs:function(n){for(var t=0;t<n.length;t++)this.changeBlobFrame(n[t]),this.drawBlob(n[t])},showInventory:function(){var i=document.getElementById("inventoryDisplay"),n,t;for(i.innerHTML="",n=0;n<this.inventory.vials.length;n++)t="",n===0?t+="<div class='selectInstruct'>A <\/div>":n===this.inventory.vials.length-1&&(t+="<div class='selectInstruct'>Z <\/div>"),t+=this.inventory.vials[n]===this.inventory.activeVial?'<img id="vial'+n+'" class="vial selected" src="'+this.inventory.vials[n].getImageUrl()+'"><br>':'<img id="vial'+n+'" class="vial" src="'+this.inventory.vials[n].getImageUrl()+'"><br>',i.innerHTML+=t},setShootOrAbsorb:function(){this.inventory.shootOrAbsorb=this.inventory.activeVial.content===null?"absorb":"shoot"},changeBlock:function(n,t){this.inventory.shootOrAbsorb==="shoot"?t.setAddColor(n):t.setSubtractColor(n);this.destroyBlocks(t);Game.setShootOrAbsorb()},shootBullet:function(n,t){if(!this.level.isSpecialLevel||this.inScene!==!0||t!=="normal")if(t==="scene"){if(this.inventory.shootOrAbsorb==="shoot"&&this.inventory.activeSceneShootColor!=null){var s=null,h=this.bulletRadius,i=0,r=0,c=this.inventory.activeSceneShootColor,f=0,e=0,u=n.x+n.spriteWidth/2,o=n.y+n.spriteHeight/2+13;n.direction==="forward"?(i=u,r=o,e=this.bulletSpeed):n.direction==="backward"?(i=u,r=n.y+10,e=-1*this.bulletSpeed):n.direction==="left"?(i=u-10,r=o-2,f=-1*this.bulletSpeed):n.direction==="right"&&(i=u+10,r=o-2,f=this.bulletSpeed);s=new Bullet(h,i,r,f,e,c,t);this.bullets.push(s)}}else if(this.inventory.shootOrAbsorb==="shoot"&&this.inventory.activeVial.content!=null){var s=null,h=this.bulletRadius,i=0,r=0,c=this.inventory.activeVial.content,f=0,e=0,u=n.x+n.spriteWidth/2,o=n.y+n.spriteHeight/2+13;n.direction==="forward"?(i=u,r=o,e=this.bulletSpeed):n.direction==="backward"?(i=u,r=n.y+10,e=-1*this.bulletSpeed):n.direction==="left"?(i=u-10,r=o-2,f=-1*this.bulletSpeed):n.direction==="right"&&(i=u+10,r=o-2,f=this.bulletSpeed);s=new Bullet(h,i,r,f,e,c,t);this.bullets.push(s);this.inventory.activeVial.content=null;this.showInventory();this.inventory.setAbsorbPermission()}},shootAbsorbRay:function(){if(this.inventory.shootOrAbsorb==="absorb"&&this.inventory.activeVial.content===null){this.absorbRay=null;var e=this.bulletRadius,n=0,t=0,o=this.inventory.absorbColors[this.inventory.activeAbsorbColorIndex],r=0,u=0,i=this.character.x+this.character.spriteWidth/2,f=this.character.y+this.character.spriteHeight/2+13;this.character.direction==="forward"?(n=i,t=f,u=this.bulletSpeed):this.character.direction==="backward"?(n=i,t=this.character.y+10,u=-1*this.bulletSpeed):this.character.direction==="left"?(n=i-10,t=f-2,r=-1*this.bulletSpeed):this.character.direction==="right"&&(n=i+10,t=f-2,r=this.bulletSpeed);this.absorbRay=new Bullet(e,n,t,r,u,o);this.useRay();this.showInventory();this.inventory.setAbsorbPermission()}},moveBullets:function(){for(var n,o,f,e,r,s,u,h,i=[],t=0;t<this.bullets.length;t++)n=this.bullets[t],n.x+=n.xSpeed,n.y+=n.ySpeed,o=this.isBlockCollision("bullet",n.x,n.y,n),f=this.isBulletBlobCollisionAll(n),console.log("blob bullet collision? "+f),n.x<0||n.y<0||n.x>this.context.canvas.width||n.y>this.context.canvas.height?(i.push(t),this.inventory.activeVial.content=n.color,this.showInventory()):o?(e=this.getRelativePosition(n.x,n.y),r=this.blocks[e[0]][e[1]],r!=null&&(s=r.color,this.changeBlock(n,r),i.push(t),s===r.color?(this.inventory.activeVial.content=n.color,this.inventory.setAbsorbPermission(),this.showInventory(),playSound("shoot fail")):playSound("shoot"),n.mode==="scene"&&(this.inventory.activeSceneShootColor=null))):f&&(console.log("bullet hit blob."),u=this.getBlobFromBulletCollision(n),h=u.color,this.changeBlob("add",u,n),i.push(t),h===u.color?(this.inventory.activeVial.content=n.color,this.showInventory(),this.inventory.setAbsorbPermission(),playSound("shoot fail")):playSound("shoot"),n.mode==="scene"&&(this.inventory.activeSceneShootColor=null));for(t=i.length-1;t>=0;t--)this.bullets.splice(i[t],1)},changeBlob:function(n,t,i){console.log("changing blob");n==="add"?t.setAddColor(i):n==="subtract"&&t.setSubtractColor(i);this.drawBlob(t)},isBulletBlobCollisionAll:function(n){for(var t=0;t<this.blobs.length;t++)if(this.isBlobCollision("bullet",n.x,n.y,n,this.blobs[t]))return!0;return!1},getBlobFromBulletCollision:function(n){for(var t=0;t<this.blobs.length;t++)if(this.isBlobCollision("bullet",n.x,n.y,n,this.blobs[t]))return this.blobs[t];return null},useRay:function(){var n=this.absorbRay,c=this.emptyAbsorbHex,p,a,b,v,r,k,u,f;console.log("ray color before: "+this.emptyAbsorbHex);var t=n.x,i=n.y,l=undefined,y=undefined,w=!1;do if(n.x+=n.xSpeed,n.y+=n.ySpeed,(n.x<0||n.y<0||n.x>this.context.canvas.width||n.y>this.context.canvas.height)&&(w=!0),l=this.isBlockCollision("ray",n.x,n.y,n),y=this.isBulletBlobCollisionAll(n),l)if(y=!1,p=this.getRelativePosition(n.x,n.y),a=this.blocks[p[0]][p[1]],a!=null){r=a.getSubtractResult(n.color,a.color);b=r[0];r[1]!="none"&&(c=a.getHex(r[1]));u=this.rayWidth;f=this.rayWidth;t=t-Math.round(u/2);i=i-Math.round(f/2);var e=undefined,o=undefined,s=undefined,h=undefined;n.x>t?(e=t,s=n.x,u=s-e):n.x<t&&(e=n.x,s=t,u=s-e);n.y>i?(o=i,h=n.y,f=h-o):n.y<i&&(o=n.y,h=i,f=h-o);t=e;i=o;this.rayDisplay=new RayDisplay(t,i,u,f,c,b);c!=this.emptyAbsorbHex?(playSound("absorb"),this.changeBlock(n,a),this.inventory.activeVial.content=r[1],this.inventory.shootOrAbsorb="shoot"):playSound("absorb fail")}else l=!1,y=!1;else if(y)if(console.log("ray hit blob"),l=!1,v=this.getBlobFromBulletCollision(n),v!=null){r=v.getSubtractResult(n.color,v.color);k=r[0];r[1]!="none"&&(c=v.getHex(r[1]));u=this.rayWidth;f=this.rayWidth;t=t-Math.round(u/2);i=i-Math.round(f/2);var e=t,o=i,s=undefined,h=undefined;n.x>t?(e=t,s=n.x,u=s-e):n.x<t&&(e=n.x,s=t,u=s-e);n.y>i?(o=i,h=n.y,f=h-o):n.y<i&&(o=n.y,h=i,f=h-o);t=e;i=o;this.rayDisplay=new RayDisplay(t,i,u,f,c,k);console.log("ray color: "+c);c!=this.emptyAbsorbHex?(playSound("absorb"),this.changeBlob("subtract",v,n),this.inventory.activeVial.content=r[1],this.inventory.shootOrAbsorb="shoot"):playSound("absorb fail")}else l=!1;while(!l&&!y&&!w)},drawRay:function(){if(this.absorbRay!=null&&this.rayDisplay!=null&&(this.context.beginPath(),this.context.fillStyle=this.rayDisplay.rayColor,this.context.fillRect(this.rayDisplay.startX,this.rayDisplay.startY,this.rayDisplay.rayWidth,this.rayDisplay.rayHeight),this.rayDisplay.rayColor===this.emptyAbsorbHex)){var n=this.confusedImage,t=this.character.x+this.character.spriteWidth/2,i=n.complete&&n.naturalHeight!==0;i?this.context.drawImage(n,t,this.character.y):this.context.drawImage(n,t,this.character.y)}this.raySecondsPassed>this.raySecondsInterval&&(this.absorbRay=null,this.rayDisplay=null)},drawBullets:function(){for(var n,t=0;t<this.bullets.length;t++)n=this.bullets[t],this.context.beginPath(),this.context.arc(n.x,n.y,n.radius,0,2*Math.PI,!1),this.context.fillStyle=n.hex,this.context.fill(),this.context.lineWidth=2,this.context.strokeStyle=n.borderHex,this.context.stroke()},checkBlobCharacterCollision:function(){var t,n;if(this.levelStarted){for(t=!1,n=0;n<this.blobs.length;n++)if(t=this.isBlobCharacterCollision(this.blobs[n]),t&&this.levelStarted===!0)if(this.blobs[n].thoughts.currentThought===this.blobs[n].thoughts.happyThought)t=!1;else break;t&&(console.log("blob character collision"),this.levelScore=0,this.levelStarted=!1,this.showCharacterDeath(),this.goToLevel(this.levelNumber))}},showCharacterDeath:function(){document.getElementById("characterDeathModal").style.display="block"},isBlobCharacterCollision:function(n){var t=n.x+n.leftEmptyPixels+1,i=n.x+n.spriteWidth-n.rightEmptyPixels-1,r=n.y+n.topEmptyPixels+1,u=n.y+n.spriteHeight+1,f=this.character.x-this.character.xOffset,e=this.character.x+this.character.spriteWidth+this.character.xOffset,o=this.character.y-this.character.yOffset+(this.character.spriteHeight/2+4),s=this.character.y+this.character.spriteHeight;if((e>t&&e<i||f<i&&f>t)&&(s>r&&s<u||o<u&&o>r))return console.log("character blob collision"),!0},isNpcCharacterCollision:function(n,t,i,r){if(t.species==="human"){var u=t.x-t.xOffset,f=t.x+t.spriteWidth+t.xOffset,e=t.y-t.yOffset+(t.spriteHeight/2+8),o=t.y+t.spriteHeight,s=i-n.xOffset,h=i+n.spriteWidth+n.xOffset,c=r-n.yOffset+(n.spriteHeight/2+8),l=r+n.spriteHeight;if((h>=u&&h<=f||s<=f&&s>=u)&&(l>=e&&l<=o||c<=o&&c>=e))return console.log("character npc collision"),!0}return!1},isBlobNpcCollision:function(n,t,i){if(n.species==="human"){if(t===n.Xi&&i===n.Yi||t===n.Xi&&i===n.Yi-1)return!0}else if(t===n.Xi&&i===n.Yi)return!0;return!1},isBlobCollision:function(n,t,i,r,u){var f=u.x+u.leftEmptyPixels+1,e=u.x+u.spriteWidth-u.rightEmptyPixels-1,o=u.y+u.topEmptyPixels+1,s=u.y+u.spriteHeight+1;if(n==="bullet"){var h=t-r.radius,c=t+r.radius,l=i-r.radius,a=i+r.radius;if((c>=f&&c<=e||h<=e&&h>=f)&&(a>=o&&a<=s||l<=s&&l>=o))return!0}else if(n==="ray"){var h=t-1,c=t+1,l=i-1,a=i+1;if((c>=f&&c<=e||h<=e&&h>=f)&&(a>=o&&a<=s||l<=s&&l>=o))return!0}return!1},isBlockCollision:function(n,t,i,r){for(var h,f,e,o,u=0;u<this.level.columns;u++)for(h=this.level.rows,h<14&&(h=14),f=0;f<h;f++)if(e=this.blocks[u][f],e!=null){var c=e.x*this.tileWidth,l=(e.x+1)*this.tileWidth-1,a=e.y*this.tileHeight,v=(e.y+1)*this.tileHeight-1;if(n==="character"){var y=t-this.character.xOffset,p=t+this.character.spriteWidth+this.character.xOffset,w=i-this.character.yOffset+this.character.spriteHeight/2,b=i+this.character.spriteHeight;if((p>c&&p<l||y<l&&y>c)&&(b>a&&b<v||w<v&&w>a))return console.log("character collision"),!0}else if(n==="bullet"){if(o=this.getRelativePosition(t,i),o[0]===u&&o[1]===f)return!0}else if(n==="ray"){if(o=this.getRelativePosition(t,i),o[0]===u&&o[1]===f)return!0}else if(n==="blob"){var s=r,k=t+s.leftEmptyPixels,d=t+s.spriteWidth-s.rightEmptyPixels,g=i+s.topEmptyPixels,nt=i+s.spriteHeight;if((d>c&&d<l||k<l&&k>c)&&(nt>a&&nt<v||g<v&&g>a))return!0}}return!1},checkDoorCollision:function(){var t=this.isDoorCollision(),n;if(t&&this.allowExit&&!this.checkExitEvents()&&!this.progressDisplayed){for(this.character.setState("standForward"),this.score+=this.levelScore,n=0;n<this.levelHelpedBlobs.length;n++)this.helpedBlobs.push(this.levelHelpedBlobs[n]);for(n=0;n<this.levelClearedBlocks.length;n++)this.clearedBlocks.push(this.levelClearedBlocks[n]);this.progressDisplayed=!0;this.displayProgress();this.levelStarted=!1}},isDoorCollision:function(){var n=this.character.x,t=this.character.y,i=this.door.x,r=this.door.x+this.door.width,u=this.door.y,f=this.door.y+this.door.height,e=n-this.character.xOffset,o=n+this.character.spriteWidth+this.character.xOffset,s=t-this.character.yOffset,h=t+this.character.spriteHeight;return(o>i&&o<r||e<r&&e>i)&&(h>u&&h<f||s<f&&s>u)?(console.log("character collision with door"),!0):!1},checkExitEvents:function(){return this.level.isSpecialLevel&&this.levelNumber===3&&this.blobs.length>0?(console.log("too many blobs"),this.changeSpriteState("ArrowDown","stop"),this.showDialogueMessage("exit",this.character,"nervous","We should probably get rid of the blobs to protect Onorio."),this.disallowMovement=!0,!0):!1},showDialogueMessage:function(n,t,i,r){var f,u,e;(this.currentDialogue===null||this.currentDialogue!=null&&this.currentDialogue.text!=r)&&(this.allowDialogue=!0,f=new Dialogue(t,i,r,0),u=[],u.push(f),e=new Conversation(this.levelNumber,n,u),this.currentConversation=e,this.currentDialogue=this.currentConversation.dialogues[0],this.showDialogue())},changeSpriteState:function(n,t){this.level.isSpecialLevel&&this.inScene===!0||this.disallowMovement!==!0&&(t==="start"?n=="ArrowUp"?(this.character.currentState=this.character.walkBackward,this.character.currentSpeed=this.character.walkSpeed,this.character.direction="backward"):n=="ArrowDown"?(this.character.currentState=this.character.walkForward,this.character.currentSpeed=this.character.walkSpeed,this.character.direction="forward"):n=="ArrowLeft"?(this.character.currentState=this.character.walkLeft,this.character.currentSpeed=this.character.walkSpeed,this.character.direction="left"):n=="ArrowRight"&&(this.character.currentState=this.character.walkRight,this.character.currentSpeed=this.character.walkSpeed,this.character.direction="right"):t==="stop"&&(n=="ArrowUp"?(this.character.currentState=this.character.standBackward,this.character.currentSpeed=0):n=="ArrowDown"?(this.character.currentState=this.character.standForward,this.character.currentSpeed=0):n=="ArrowLeft"?(this.character.currentState=this.character.standLeft,this.character.currentSpeed=0):n=="ArrowRight"&&(this.character.currentState=this.character.standRight,this.character.currentSpeed=0),this.character.currentStateFrame=this.character.currentState.frames[0],this.character.frameIndex=0))},continueSpriteFrames:function(n){var i=n.currentState.frames.length,t=n.currentStateFrame.index+1;t>=i&&(t=0);n.currentStateFrame=n.currentState.frames[t]},moveCharacter:function(n,t,i){var r,u,s,f,e,h,o;if((this.levelStarted!==!1||!this.level.isSpecialLevel||this.inScene!==!0||this.currentAnimationInterval!==null&&this.currentAnimationInterval.animationType=="move")&&!this.showInventoryMenu&&n.currentSpeed!==0&&n.x!==null&&n.y!==null){if(r=[n.x,n.y],n.direction==="forward"?(u=n.y+n.currentSpeed,u<n.yOffset?u=n.yOffset:u+n.spriteHeight>this.context.canvas.height&&(this.inScene||(u=this.context.canvas.height-n.spriteHeight)),i!=-100&&u>i&&(u=i),r[1]=u):n.direction==="backward"?(u=n.y-n.currentSpeed,u<n.yOffset?u=n.yOffset:u>this.context.canvas.height-n.spriteHeight&&(u=this.context.canvas.height-n.spriteHeight),i!=-100&&u<i&&(u=i),r[1]=u):n.direction==="left"?(f=n.x-n.currentSpeed,f<n.xOffset?f=n.xOffset:f>this.context.canvas.width-n.xOffset&&(f=this.context.canvas.width-n.xOffset),t!=-100&&f<t&&(f=t),r[0]=f):n.direction==="right"&&(s=this.context.canvas.width-46,f=n.x+n.currentSpeed,f<n.xOffset?f=n.xOffset:f>s&&(f=s),t!=-100&&f>t&&(f=t),r[0]=f),e=!1,h=!0,n.isNpc){for(h=!1,o=0;o<this.npcs.length;o++)if(this.npcs[o].name!=n.name){if(e=this.isNpcCharacterCollision(n,this.npcs[o],r[0],r[1]),e)break}else if(e=this.isNpcCharacterCollision(n,this.character,r[0],r[1]),e)break}else for(o=0;o<this.npcs.length;o++)if(e=this.isNpcCharacterCollision(n,this.npcs[o],r[0],r[1]),e)break;h?this.isBlockCollision("character",r[0],r[1],n)||e||(n.x=r[0],n.y=r[1],this.setCharacterRelativePositions(n)):e||(n.x=r[0],n.y=r[1],this.setCharacterRelativePositions(n));this.continueSpriteFrames(n)}},fillWithBlocks:function(){var i=this.level.rows,n,t;for(i<14&&(i=14),n=0;n<this.level.columns;n++)for(t=this.spaceAtEdges;t<i-this.spaceAtEdges;t++)this.generateRandomBlock(n,t)},generateRandomBlock:function(n,t){var r=!1,i=undefined;do{var u=getTileColors(this.level),f=Math.floor(Math.random()*u.length),e=u[f];i=this.createBlock(e,n,t);r=this.isBlockValid(i)}while(!r);this.drawBlock(i);this.blocks[n][t]=i},isBlockValid:function(n){var t=this.countBlocksInRow(n,null);return t<this.level.blocksForScore?!0:!1},countBlocksInRow:function(n,t){var s=n.color,f=0,r=[[n.x,n.y-1],[n.x+1,n.y],[n.x,n.y+1],[n.x-1,n.y]],e,i,u,o;for(t===null&&(t=[],t.push(n),f++),e=Game.level.rows,e<14&&(e=14),i=0;i<r.length;i++)r[i][0]>=0&&r[i][0]<this.level.columns&&r[i][1]>=0&&r[i][1]<e&&this.blocks[r[i][0]][r[i][1]]!=null&&(u=this.blocks[r[i][0]][r[i][1]],u.color!==s||this.isContainedInBlockList(u,t)||(t.push(u),f++,o=this.countBlocksInRow(u,t),f+=o));return f},destroyBlocks:function(n){var t=[n],r,i;if(t=this.getBlocksInRow(n,t),r=this.level.blocksForScore,t.length>=r)for(i=0;i<t.length;i++)this.blocks[t[i].x][t[i].y].startDestroy()},clearBlock:function(n){this.levelClearedBlocks.push(n);this.addBlocksToScore([n]);this.blocks[n.x][n.y]=null},getBlocksInRow:function(n,t){var s=n.color,e=0,r=[[n.x,n.y-1],[n.x+1,n.y],[n.x,n.y+1],[n.x-1,n.y]],f,i,u,o;for(t===null&&(t=[],t.push(n),e++),f=Game.level.rows,f<14&&(f=14),i=0;i<r.length;i++)r[i][0]>=0&&r[i][0]<this.level.columns&&r[i][1]>=0&&r[i][1]<f&&this.blocks[r[i][0]][r[i][1]]!=null&&(u=this.blocks[r[i][0]][r[i][1]],u.color!==s||this.isContainedInBlockList(u,t)||(t.push(u),e++,o=this.getBlocksInRow(u,t),e+=o));return t},isContainedInBlockList:function(n,t){for(var i=0;i<t.length;i++)if(n.x===t[i].x&&n.y===t[i].y)return!0;return!1},createBlock:function(n,t,i){return new Block(this.tileWidth,this.tileHeight,t,i,n)},drawBlock:function(n){if(n.color!=="invisible"){var t=n.x*this.tileWidth,i=n.y*this.tileHeight;this.context.beginPath();this.context.fillStyle=n.hex;this.context.fillRect(t+2,i+2,this.tileWidth-4,this.tileHeight-4);this.context.lineWidth="4";this.context.strokeStyle=n.borderHex;this.context.rect(t+2,i+2,this.tileWidth-4,this.tileHeight-4);this.context.stroke();n.doHighlight&&(this.context.lineWidth="3.5",this.context.strokeStyle=n.highlightHex,this.context.rect(t,i,this.tileWidth,this.tileHeight),this.context.stroke());n.isDestroyed?this.clearBlock(n):n.beingDestroyed&&n.destroyLoop()}},redrawBlocks:function(){var i=this.level.rows,n,t;for(i<14&&(i=14),n=0;n<this.level.columns;n++)for(t=0;t<i;t++)this.blocks[n][t]!=null&&this.drawBlock(this.blocks[n][t])},setCanvas:function(){console.log("setting canvas");var t=this.level.columns,n=this.level.rows;n<14?(n=14,this.spaceAtEdges=4):this.spaceAtEdges=3;this.context.canvas.width=this.tileWidth*t;this.context.canvas.height=this.tileHeight*n;this.context.canvas.style.border="2px solid #000000";this.drawGrid()},setCharacterRelativePositions:function(n){var t=n.x+n.spriteHeight/2,i=n.y+n.spriteHeight/2,r=Math.ceil(t/this.tileWidth)-1,u=Math.ceil(i/this.tileHeight)-1;n.Xi=r;n.Yi=u},getRelativePosition:function(n,t){var i=Math.ceil(n/this.tileWidth)-1,r=Math.ceil(t/this.tileHeight)-1;return[i,r]},drawCharacter:function(){var o=this.character.currentStateFrame.startX,s=this.character.currentStateFrame.startY,r=this.character.currentStateFrame.width,u=this.character.currentStateFrame.height,c=Math.round((this.character.currentStateFrame.width-this.tileWidth)/2),l=Math.round((this.character.currentStateFrame.height-this.tileHeight)/2),n=undefined,t=undefined,a,f,e,i,h;this.character.x===null?(n=Math.round(this.character.Xi*this.tileWidth-c),this.character.x=n):n=this.character.x;this.character.y===null?(t=Math.round(this.character.Yi*this.tileHeight-l),this.character.y=t):t=this.character.y;a=225;n<this.character.xOffset?n=this.character.xOffset:n+r>this.canvas.width&&(n=this.canvas.width-r);t<this.character.yOffset?t=this.character.yOffset:t+u>this.canvas.height&&(t=this.canvas.height-u);this.character.x=n;this.character.y=t;f=r;e=u;this.character.checkPipeAnimation();i=this.character.currentStateFrame.image;h=i.complete&&i.naturalHeight!==0;h?(Game.context.drawImage(i,o,s,r,u,n,t,f,e),Game.drawCharacterThought(Game.character,n,t)):i.addEventListener("load",function(){Game.context.drawImage(i,o,s,r,u,n,t,f,e);Game.drawCharacterThought(Game.character,n,t)});this.character.drawPipeFront()},drawNpcs:function(n){for(var t=0;t<n.length;t++)this.drawNpc(n[t])},drawNpc:function(n){var s=n.currentStateFrame.startX,h=n.currentStateFrame.startY,u=n.currentStateFrame.width,f=n.currentStateFrame.height,l=Math.round((n.currentStateFrame.width-this.tileWidth)/2),a=Math.round((n.currentStateFrame.height-this.tileHeight)/2),t=undefined,i=undefined,v,e,o,r,c;n.x===null?(t=Math.round(n.Xi*this.tileWidth-l),n.x=t):t=n.x;n.y===null?(i=Math.round(n.Yi*this.tileHeight-a),n.y=i):i=n.y;v=225;t<n.xOffset?t=n.xOffset:t+u>this.canvas.width&&(t=this.canvas.width-u);i<n.yOffset?i=n.yOffset:i+f>this.canvas.height&&(i=this.canvas.height-f);n.x=t;n.y=i;e=u;o=f;n.checkPipeAnimation(this);r=n.currentStateFrame.image;c=r.complete&&r.naturalHeight!==0;c?(Game.context.drawImage(r,s,h,u,f,t,i,e,o),Game.drawCharacterThought(n,t,i)):r.addEventListener("load",function(){Game.context.drawImage(r,s,h,u,f,t,i,e,o);Game.drawCharacterThought(n,t,i)});n.drawPipeFront()},drawGrid:function(){var r,n,t,i;for(this.context.beginPath(),this.context.clearRect(0,0,this.context.canvas.width,this.context.canvas.height),this.context.fillStyle=this.canvasBackgroundColor,this.context.fillRect(0,0,this.context.canvas.width,this.context.canvas.height),r=this.canvasGridColor,n=1;n<this.level.columns;n++){var u=n*this.tileWidth,e=this.context.canvas.height;this.context.strokeStyle=r;this.context.beginPath();this.context.lineWidth=1;this.context.moveTo(u,0);this.context.lineTo(u,e);this.context.stroke()}for(t=this.level.rows,t<14&&(t=14),i=1;i<t;i++){var f=i*this.tileWidth,o=this.context.canvas.width;this.context.strokeStyle=r;this.context.beginPath();this.context.lineWidth=1;this.context.moveTo(0,f);this.context.lineTo(o,f);this.context.stroke()}},setGameArea:function(){var n=document.getElementById("gameArea"),i=this.context.canvas.width+275,t;n.style.width=i+"px";t=this.context.canvas.height+60;n.style.height=t+"px"},addBlobToScore:function(n){var i=3,t=0,r=n.color;r==="white"?(console.log("white"),t=this.whiteValue*i):r==="black"?(t=this.blackValue*i,console.log("black")):this.isPrimary(r)?(t=this.primaryValue*i,console.log("primary")):this.isSecondary(r)&&(t=this.secondaryValue*i,console.log("secondary"));this.levelScore+=Math.round(t);this.updateScoreText()},addBlocksToScore:function(n){var t=0,u=0,i=n[0].color,f,r;for(console.log("block color: "+i),i==="white"?(console.log("white"),t=this.whiteValue):i==="black"?(t=this.blackValue,console.log("black")):this.isPrimary(i)?(t=this.primaryValue,console.log("primary")):this.isSecondary(i)&&(t=this.secondaryValue,console.log("secondary")),f=1,r=0;r<n.length;r++)r>=this.level.blocksForScore&&(f+=.6),u+=t*f;this.levelScore+=Math.round(u);console.log("adding "+Math.round(u));this.updateScoreText()},updateScoreText:function(){this.scoreText.innerHTML=this.score+this.levelScore},updateLevelText:function(){this.levelText.innerHTML=this.levelNumber},isPrimary:function(n){return(console.log("checking primary: "+n),n==="red"||n==="yellow"||n==="blue")?(console.log(!0),!0):(console.log(!1),!1)},isSecondary:function(n){return(console.log("checking secondary: "+n),n==="orange"||n==="green"||n==="purple")?(console.log(!0),!0):(console.log(!1),!1)},createDoor:function(){this.door=new Door(this.doorColor,this.tileWidth,this.tileHeight,this.context.canvas.width,this.context.canvas.height)},drawDoor:function(){this.context.beginPath();this.context.fillStyle=this.door.doorHex;this.context.fillRect(this.door.x,this.door.y,this.door.width,this.door.height)},showNextInScene:function(){var n,u;if(this.openingScene!==null){if(this.openingScene.animation!=null&&this.openingScene.actionOrder[this.openingScene.actionIndex]==="A"){this.allowDialogue=!1;var i=this.openingScene.animation.animations[this.openingScene.animationIndex],t=i.animationsAtOnce,r=!0;for(n=0;n<t;n++)u=i.animationIndex+n,this.currentAnimationInterval=this.openingScene.animation.animations[u],this.currentAnimationInterval.complete?(this.currentAnimationInterval.animationType==="move"&&this.currentAnimationInterval.character.name!="Harley"&&(this.npcsMoving=!1),this.openingScene.animationIndex>=this.openingScene.animation.animations.length&&(this.openingScene.animationIndex=0),this.openingScene===null?this.currentAnimationInterval=null:(this.currentAnimationInterval=this.openingScene.animation.getNextInterval(),this.allowDialogue=!0)):(r=!1,this.currentAnimationInterval.animationType==="move"&&this.currentAnimationInterval.character.name!="Harley"&&(this.npcsMoving=!0),this.performAnimationInterval());r&&(this.openingScene.animationIndex+=t,this.openingScene.actionIndex+=t)}else this.currentDialogue==null||this.currentDialogue.complete?this.currentDialogue===null?this.showOpeningScene?this.currentConversation=null:(this.openingScene.conversationIndex++,this.openingScene.actionIndex++):this.currentDialogue=this.currentConversation.getNextDialogue():(this.allowDialogue=!0,this.showDialogue());this.showOpeningScene===!1&&this.currentAnimationInterval===null&&this.currentConversation===null&&this.currentDialogue===null&&this.openingScene.animationIndex>=this.openingScene.animation.animations.length?this.openingScene.repeatConvoSeen?(console.log("scene complete"),this.levelStarted=!0,this.inScene=!1,this.openingScene=null):(this.currentConversation=getRepeatSceneConversation(this.levelNumber),this.currentDialogue=this.currentConversation.dialogues[0],this.showDialogue()):(this.openingScene.animation===null||this.openingScene.animation.animations===null||this.openingScene.animation.animations.length===0||this.openingScene.animation.animations[this.openingScene.animation.animations.length-1].complete)&&(this.openingScene.conversation===null||this.openingScene.conversation.dialogues===null||this.openingScene.conversation.dialogues.length===0||this.openingScene.conversation.dialogues[this.openingScene.conversation.dialogues.length-1].complete)&&(console.log("scene complete"),this.levelStarted=!0,this.inScene=!1,this.openingScene=null,this.showOpeningScene=!1)}},showDialogue:function(){this.currentDialogue!=null&&this.allowDialogue&&(this.levelStarted=!1,this.currentDialogue.drawDialogueBox(this.context))},endCurrentDialogue:function(){this.currentDialogue.complete=!0},getNextDialogue:function(){var n,t;this.currentDialogue.complete=!0;this.currentConversation.type==="exit"?(this.currentDialogue=this.currentConversation.getNextDialogue(),this.currentDialogue===null&&(n=this.level.rows,n<14&&(n=14),t=n-1,this.currentAnimationInterval=new OpeningAnimationInterval(0,1,this.character,"move","backward",this.character.Xi,t-1,null),this.performExitAnimation())):(this.currentDialogue=this.currentConversation.getNextDialogue(),this.openingScene.conversationIndex>=this.openingScene.conversation.dialogues.length&&this.openingScene.conversationIndex++,this.openingScene.actionIndex++,this.currentDialogue===null&&this.currentAnimationInterval&&(this.levelStarted=!0,this.currentConversation=null))},performExitAnimation:function(){this.performAnimationInterval();this.currentAnimationInterval.complete&&(this.currentAnimationInterval=null,this.character.goalX=-100,this.character.goalY=-100,this.levelStarted=!0,this.inScene=!1,this.allowDialogue=!1,this.currentConversation=null,this.disallowMovement=!1)},setConversation:function(n){n==="opening"?this.level.isSpecialLevel&&(this.currentConversation=this.level.openingScene.conversation,this.currentDialogue=this.currentConversation.getDialogue()):(this.currentConversation=null,this.currentDialogue=null)},setAnimationInterval:function(n){this.level.openingScene.animation.animations!=null&&this.level.openingScene.animation.animations.length!=0&&(this.currentAnimationInterval=this.level.openingScene.animation.animations[n])},performAnimationInterval:function(){this.currentAnimationInterval.continueAnimation(this)},setOpeningScene:function(){var t,n,i;if(this.level.isSpecialLevel){if(this.openingScene=this.level.openingScene,this.openingScene===null)this.currentAnimationInterval=null,this.currentConversation=null,this.currentDialogue=null,this.inScene=!1;else if(this.showOpeningScene?this.setConversation("opening"):this.setConversation("none"),this.level.openingScene.animation!=null&&this.setAnimationInterval(0),this.inScene=!0,!this.showOpeningScene&&this.openingScene.startAtEndOnReturn){for(t=this.openingScene.endInfo,n=0;n<t.length;n++)if(t[n].Xi===null&&t[n].Yi===null){if(t[n].character.isNpc)for(i=0;i<this.npcs.length;i++)if(this.npcs[i].name===t[n].character.name){this.npcs.splice(i,1);break}}else t[n].character.Xi=t[n].Xi,t[n].character.Yi=t[n].Yi,t[n].character.x=null,t[n].character.y=null;this.currentAnimationInterval=null;this.currentConversation=null;this.currentDialogue=null;this.inScene=!1;this.openingScene=null}}else this.inScene=!1},testStartConversation:function(){this.currentConversation=testConversation;this.currentDialogue=this.currentConversation.getDialogue()},testShowDialogue:function(){this.currentDialogue=testDialogue},testHideDialogue:function(){this.currentDialogue=null},testShowMood:function(n,t,i){if(n.currentMood!==null){var e=n.currentMood.visual.startX,o=n.currentMood.visual.startY,u=n.currentMood.visual.width,f=n.currentMood.visual.height,s=u,h=f,r=n.currentMood.visual.image,c=r.complete&&r.naturalHeight!==0;c?Game.context.drawImage(r,e,o,u,f,t,i,s,h):r.addEventListener("load",function(){Game.context.drawImage(r,e,o,u,f,t,i,s,h)})}},testDrawPipe:function(){var t=8*this.tileWidth,i=2*this.tileHeight,n=new Image,r;n.src="images/pipe-sprites/pipe-single1.png";r=n.complete&&n.naturalHeight!==0;r?Game.context.drawImage(n,0,0,58,64,t,i,40,44):n.addEventListener("load",function(){Game.context.drawImage(n,0,0,58,64,t,i,40,44)})},skipToDoor:function(){var n=this.context.canvas.height-this.tileHeight*3;this.character.y=n},goToLevel:function(n,t){this.levelNumber=n-1;this.level=this.levels[n-2];this.levelScore=0;this.goToNextLevel(t)},restartLevel:function(){this.inScene!=!0&&(generateAllLevels(this.gameType),this.goToLevel(this.levelNumber,!1))}};